---
editor_options: 
  markdown: 
    wrap: 86
---

# Query data from NILS: Vegetation cover in two time periods

```{r setup, message=FALSE, warning=FALSE}
library(jsonlite)
library(dplyr)
library(tidyr)
library(conflicted)
conflicts_prefer( dplyr::select, dplyr::filter)
library(glue)
library(ggplot2)
```

## NILS APIs: query data via urls

[Swagger description of NILS apis](https://landskap.slu.se/api/nils/index.html)

[NILS sampling method description (in
Swedish)](https://www.slu.se/globalassets/ew/org/centrb/nils/publikationer/2019/nils_faltinstruktion_webb_ht_2019_2.pdf)

### All data from endpoint 'Klasser'

<https://landskap.slu.se/api/nils/api/>

```{r ex_api, eval=FALSE}
urlApi <- 'https://landskap.slu.se/api/nils/api/'
endpoint <- 'Klasser'
klasserUrl <- url(glue('{urlApi}{endpoint}'))
klasserGet <- fromJSON(klasserUrl)
klasser <- klasserGet$data
```

### Extrahera metadata från apiet habitat

```{r}
urlApi <- 'https://landskap.slu.se/api/nils/api/'
endpoint <- 'HabitatKlasser/variablesMetadata'
HabitatMetaUrl <- url(glue('{urlApi}{endpoint}'))
habitatMetaGet <- fromJSON(HabitatMetaUrl) 
habitatMeta <- habitatMetaGet$data
```

## Combine data from different tables

Example from [@hedenås2016]

![The map shows the location of stratum 10 (gray), i.e., the Swedish mountain region,
and the 145 systematically placed 5 × 5 km sample units (red). The 12 circular sample
plots is in the center of the sample unit with a distance of 250 m between the centers
of each plot and a distance of 2125 m between the centers of each plot and the edge of
the 5 × 5 km2. Each plot consists of two concentric circular plots, and different
variables are recorded in these plots. Canopy cover is estimated in the 20-m radius
plot, and shrub cover, cover of field vegetation, and cover of the bottom layer are
estimated in the 10-m radius plot. The sample plot is divided into subplots if the
sample plot contains distinct areas of different types of land use or land cover etc.
(Esseen et al. 2007). The figure also shows a list of the field variables used in this
study sorted size of the circular sample
plots](images/hedenas_%20fig1_map-shows-the-location-of-stratum.png)

Kombinera data från apiet Klasser med data från apiet Vegetationstackning\
Extrahera data från 2020 från apiet Klasser som innehåller alla delytor

```{r classes, message=FALSE, warning=FALSE}
# years <- paste0("Ar=",c(2003:2012), collapse = "&")
years <- paste0(c(2003:2012), collapse = ",")
endpoint <- 'Klasser'
klasserUrl <- url(glue('{urlApi}{endpoint}?ArIN={years}'))
klasserGet <- fromJSON(klasserUrl)
klasser <- klasserGet$data
```

Extrahera data från apiet Vegetationstackning

```{r vegetation, message=FALSE, warning=FALSE}
endpoint <- 'Vegetationstackning'
vegetationUrl <- url(glue('{urlApi}{endpoint}?ArIN={years}'))
vegetationGet <- fromJSON(vegetationUrl)
vegetation <- vegetationGet$data |>
  select(-c("koordNS","koordEW","lan","kommun","bioGeoRegion","stratum")) # Ta bort de kolumner som finns i bägge apierna och som inte behövs för att slå samman tabellerna
# names(vegetation)
```

Kombinera tabellerna till en gemensam tabell

```{r combine, message=FALSE, warning=FALSE}
klassVegetation <- klasser  |> 
  filter(lan != "Utlandet", 
         fjalltyp %in% c("Fjällbjörkskog", "Område ovan SKOGSgränsen"),
         ar <= 2012) |> 
  left_join(vegetation, by = c("ar","rutaNummer", "provytaNummer","delytaNummer")) |> 
  mutate(survPer = ifelse(ar < 2007, "2003-2007", "2008-2012"))

# range(klassVegetation$tradTackningTotal, na.rm = TRUE)
# range(klassVegetation$ar, na.rm = TRUE)

klassVegetationPL <- klassVegetation |> 
  select(fjalltyp, survPer, tradTackningTotal, buskTackningTotal, faltskiktTackningTotal) |> 
  pivot_longer(!c(fjalltyp, survPer), names_to = "layer", values_to = "cover")

kvSumm <- klassVegetationPL |> 
  group_by(fjalltyp, survPer, layer) |> 
  summarise_at(.vars = vars(cover), 
               .funs = list(mean = ~mean(., na.rm = TRUE), 
                            sd = ~sd(., na.rm = TRUE)),
               .grups = "drop") |> 
  mutate_at(vars(fjalltyp, survPer, layer), list(factor)) |> 
  as.data.frame()
```

```{r plot_kvSumm, message=FALSE, warning=FALSE}
ggplot(kvSumm, aes(x = layer, y = mean, color = survPer)) +
  geom_point(position = position_dodge(0.2)) +
  geom_errorbar(aes(ymin = mean - sd, 
                    ymax = mean + sd), 
                width = .1, 
                position = position_dodge(0.2)) + 
  facet_wrap(vars(fjalltyp), 
             labeller = as_labeller(c("Fjällbjörkskog" = "Mountain birch forest", 
                                      "Område ovan SKOGSgränsen" = "Alpine"))) +
  labs(y = "Total cover (%)", x = "Layer", color = "Inventory lap") +
  scale_x_discrete(labels = c("Shrub", "Field", "Tree"))

```
