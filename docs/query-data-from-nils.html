<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Query data from NILS |     A general workflow for analysis of primary biodiversity data</title>
  <meta name="description" content="  A general workflow for analysis of primary biodiversity data" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Query data from NILS |     A general workflow for analysis of primary biodiversity data" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://biodiversitydata-se.github.io/biodiversity-analysis-tools/images/sbdi-logo-orginal-large.png" />
  
  <meta name="github-repo" content="biodiversitydata-se/biodiversity-analysis-tools" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Query data from NILS |     A general workflow for analysis of primary biodiversity data" />
  
  
  <meta name="twitter:image" content="https://biodiversitydata-se.github.io/biodiversity-analysis-tools/images/sbdi-logo-orginal-large.png" />

<meta name="author" content="Debora Arlt, Alejandro Ruete and Charles Campbell  for the Swedish Biodiversity Data Infrastructure" />


<meta name="date" content="2023-07-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="images/favicon_io/favicon.ico" type="image/x-icon" />
<link rel="prev" href="essential-biodiversity-variables.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Biodiversity analysis tools</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html"><i class="fa fa-check"></i><b>2</b> The importance of questions and sources of data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#questions"><i class="fa fa-check"></i><b>2.1</b> Questions</a></li>
<li class="chapter" data-level="2.2" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#taxonomies"><i class="fa fa-check"></i><b>2.2</b> Taxonomies</a></li>
<li class="chapter" data-level="2.3" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#data-sources"><i class="fa fa-check"></i><b>2.3</b> Data Sources</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#biodiversity-record-data"><i class="fa fa-check"></i><b>2.3.1</b> Biodiversity record data</a></li>
<li class="chapter" data-level="2.3.2" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#taxonomic-diversity"><i class="fa fa-check"></i><b>2.3.2</b> Taxonomic diversity</a></li>
<li class="chapter" data-level="2.3.3" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#functional-diversity"><i class="fa fa-check"></i><b>2.3.3</b> Functional diversity</a></li>
<li class="chapter" data-level="2.3.4" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#genetic-data-bases"><i class="fa fa-check"></i><b>2.3.4</b> Genetic data bases</a></li>
<li class="chapter" data-level="2.3.5" data-path="the-importance-of-questions-and-sources-of-data.html"><a href="the-importance-of-questions-and-sources-of-data.html#environemntal-data"><i class="fa fa-check"></i><b>2.3.5</b> Environemntal data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-cleaning.html"><a href="data-cleaning.html"><i class="fa fa-check"></i><b>3</b> Data cleaning</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-cleaning.html"><a href="data-cleaning.html#resources"><i class="fa fa-check"></i><b>3.1</b> Resources</a></li>
<li class="chapter" data-level="3.2" data-path="data-cleaning.html"><a href="data-cleaning.html#taxonomies-1"><i class="fa fa-check"></i><b>3.2</b> Taxonomies</a></li>
<li class="chapter" data-level="3.3" data-path="data-cleaning.html"><a href="data-cleaning.html#location-data"><i class="fa fa-check"></i><b>3.3</b> Location data</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="data-cleaning.html"><a href="data-cleaning.html#locality-information"><i class="fa fa-check"></i><b>3.3.1</b> Locality information</a></li>
<li class="chapter" data-level="3.3.2" data-path="data-cleaning.html"><a href="data-cleaning.html#coordinate-uncertainty"><i class="fa fa-check"></i><b>3.3.2</b> Coordinate uncertainty</a></li>
<li class="chapter" data-level="3.3.3" data-path="data-cleaning.html"><a href="data-cleaning.html#coordinate-errors"><i class="fa fa-check"></i><b>3.3.3</b> Coordinate errors</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="data-cleaning.html"><a href="data-cleaning.html#examples"><i class="fa fa-check"></i><b>3.4</b> Examples</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="data-cleaning.html"><a href="data-cleaning.html#data-cleaning-cyperaceae-in-sweden"><i class="fa fa-check"></i><b>3.4.1</b> Data cleaning Cyperaceae in Sweden</a></li>
<li class="chapter" data-level="3.4.2" data-path="data-cleaning.html"><a href="data-cleaning.html#taxonomy"><i class="fa fa-check"></i><b>3.4.2</b> Taxonomy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="fitness-for-use.html"><a href="fitness-for-use.html"><i class="fa fa-check"></i><b>4</b> Fitness for use</a>
<ul>
<li class="chapter" data-level="4.1" data-path="fitness-for-use.html"><a href="fitness-for-use.html#bias"><i class="fa fa-check"></i><b>4.1</b> Bias</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html"><i class="fa fa-check"></i><b>5</b> Data Exploration and Transformation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html#wide"><i class="fa fa-check"></i><b>5.1</b> Wide</a></li>
<li class="chapter" data-level="5.2" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html#long"><i class="fa fa-check"></i><b>5.2</b> Long</a></li>
<li class="chapter" data-level="5.3" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html#wide-to-long"><i class="fa fa-check"></i><b>5.3</b> Wide to long</a></li>
<li class="chapter" data-level="5.4" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html#long-to-wide"><i class="fa fa-check"></i><b>5.4</b> Long to Wide</a></li>
<li class="chapter" data-level="5.5" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html#spatial-data"><i class="fa fa-check"></i><b>5.5</b> Spatial data</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html#spatial-vector-data"><i class="fa fa-check"></i><b>5.5.1</b> Spatial vector data</a></li>
<li class="chapter" data-level="5.5.2" data-path="data-exploration-and-transformation.html"><a href="data-exploration-and-transformation.html#raster"><i class="fa fa-check"></i><b>5.5.2</b> Raster</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html"><i class="fa fa-check"></i><b>6</b> Essential Biodiversity Variables</a>
<ul>
<li class="chapter" data-level="6.1" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#sdm"><i class="fa fa-check"></i><b>6.1</b> SDM</a></li>
<li class="chapter" data-level="6.2" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#diversity"><i class="fa fa-check"></i><b>6.2</b> Diversity</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#types-of-analyses---patitioning-alpha-beta-gamma-etc.-diversity"><i class="fa fa-check"></i><b>6.2.1</b> Types of analyses - Patitioning <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\gamma\)</span> <em>etc.</em> diversity</a></li>
<li class="chapter" data-level="6.2.2" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#data-form"><i class="fa fa-check"></i><b>6.2.2</b> Data form</a></li>
<li class="chapter" data-level="6.2.3" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#classic-diversity-measures"><i class="fa fa-check"></i><b>6.2.3</b> Classic diversity measures</a></li>
<li class="chapter" data-level="6.2.4" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#alpha-diversity"><i class="fa fa-check"></i><b>6.2.4</b> <span class="math inline">\(\alpha\)</span> diversity</a></li>
<li class="chapter" data-level="6.2.5" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#beta-diversity-and-dissimilarities"><i class="fa fa-check"></i><b>6.2.5</b> <span class="math inline">\(\beta\)</span> diversity and dissimilarities</a></li>
<li class="chapter" data-level="6.2.6" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#additional-related-diversities"><i class="fa fa-check"></i><b>6.2.6</b> Additional related diversities</a></li>
<li class="chapter" data-level="6.2.7" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#numbers-equivalents"><i class="fa fa-check"></i><b>6.2.7</b> Numbers equivalents</a></li>
<li class="chapter" data-level="6.2.8" data-path="essential-biodiversity-variables.html"><a href="essential-biodiversity-variables.html#example-of-analysis-of-diversity"><i class="fa fa-check"></i><b>6.2.8</b> Example of analysis of diversity</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="query-data-from-nils.html"><a href="query-data-from-nils.html"><i class="fa fa-check"></i><b>7</b> Query data from NILS</a>
<ul>
<li class="chapter" data-level="7.1" data-path="query-data-from-nils.html"><a href="query-data-from-nils.html#a-brief-intro-to-nils"><i class="fa fa-check"></i><b>7.1</b> A brief intro to NILS</a></li>
<li class="chapter" data-level="7.2" data-path="query-data-from-nils.html"><a href="query-data-from-nils.html#vegetation-cover-in-two-time-periods"><i class="fa fa-check"></i><b>7.2</b> Vegetation cover in two time periods</a></li>
<li class="chapter" data-level="7.3" data-path="query-data-from-nils.html"><a href="query-data-from-nils.html#blueberry-and-mountain-violet-occurrence-in-the-alpine-region"><i class="fa fa-check"></i><b>7.3</b> Blueberry and mountain violet occurrence in the alpine region</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><img src='images/sbdi-logo-orginal-large.png' class='cover'/> <br><br> A general workflow for analysis of primary biodiversity data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="query-data-from-nils" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7</span> Query data from NILS<a href="query-data-from-nils.html#query-data-from-nils" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="a-brief-intro-to-nils" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> A brief intro to NILS<a href="query-data-from-nils.html#a-brief-intro-to-nils" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>On behalf of the Swedish Environmental Protection Agency, SLU documents, through NILS
(National Inventory of the Landscape in Sweden), landscape and vegetation changes in
Sweden and thus how the conditions for biological diversity look and change over time.
<a href="https://www.slu.se/centrumbildningar-och-projekt/nils/">NILS</a>’ base inventory took
place in the years 2003 to 2018 throughout Sweden and in the years 2019 to 2020 only
in the mountains. The purpose of the inventory was to collect data in the field,
analyze and present estimates of conditions and changes. The inventory is based on a
random sample of permanent sample areas. It takes five years to complete an inventory
lap; round 1 ran from 2003 to 2007, round 2 from 2008 to 2012, etc. The data is
collected via field inventory in sample areas and transects. In the sample area
inventory, data is partly collected in larger circular sample areas with a radius of
10 meters and in small sample areas with a radius of 0.28 m where mainly species,
species groups, habitat types and other classifications are recorded. More information
about design and methodology can be found
<a href="https://www.slu.se/centrumbildningar-och-projekt/nils/">here</a> and <a href="https://www.slu.se/globalassets/ew/org/centrb/nils/publikationer/2019/nils_faltinstruktion_webb_ht_2019_2.pdf">here (in
Swedish)</a>.</p>
<div class="float" id="figMethod">
<img src="images/hedenas_%20fig1_map-shows-the-location-of-stratum.png" class="illustration" alt="The map shows the location of stratum 10 (gray), i.e., the Swedish mountain region, and the 145 systematically placed 5 × 5 km sample units (red). The 12 circular sample plots is in the center of the sample unit with a distance of 250 m between the centers of each plot and a distance of 2125 m between the centers of each plot and the edge of the 5 × 5 km2. Each plot consists of two concentric circular plots, and different variables are recorded in these plots. Canopy cover is estimated in the 20-m radius plot, and shrub cover, cover of field vegetation, and cover of the bottom layer are estimated in the 10-m radius plot. The sample plot is divided into subplots if the sample plot contains distinct areas of different types of land use or land cover etc. (Esseen et al. 2007). The figure also shows a list of the field variables used in this study sorted size of the circular sample plots." />
<div class="figcaption">The map shows the location of stratum 10 (gray), i.e., the Swedish mountain region,
and the 145 systematically placed 5 × 5 km sample units (red). The 12 circular sample
plots is in the center of the sample unit with a distance of 250 m between the centers
of each plot and a distance of 2125 m between the centers of each plot and the edge of
the 5 × 5 km2. Each plot consists of two concentric circular plots, and different
variables are recorded in these plots. Canopy cover is estimated in the 20-m radius
plot, and shrub cover, cover of field vegetation, and cover of the bottom layer are
estimated in the 10-m radius plot. The sample plot is divided into subplots if the
sample plot contains distinct areas of different types of land use or land cover etc.
(Esseen et al. 2007). The figure also shows a list of the field variables used in this
study sorted size of the circular sample
plots.</div>
</div>
<p>This inventory contributes with an environmental target indicator for monitoring the
environmental target “A magnificent mountain environment” - monitoring of vegetation
changes in the mountains.</p>
<p>All inventory data can be downloaded without registering and is available at <a href="https://landskap.slu.se/nils/dv">NILS
datavärdskap</a>. The data is also available via REST
APIs (Application Program Interface). More documentation can be found at <a href="https://landskap.slu.se/api/nils/index.html">Swagger
description of NILS’ APIs</a>. APIs are
suitable for a replicable and streamlined analysis sending queries directly to the
database therefore avoiding the unnecessary download of complete data sets. REST APIs
are URL (a web address) with endpoint paths to resources and parameters for filtering
the query. REST API URLs are often composed as follows:</p>
<blockquote>
<p><u><strong>Base URL</strong>:
<a href="http://apiserver.com/homes?limit=5&amp;format=json">http://apiserver.com</a></u></p>
<p><u><strong>Endpoint Path</strong>:
<a href="http://apiserver.com/homes?limit=5&amp;format=json">/homes</a></u> for the
resource ‘homes’</p>
<p><u><strong>Query String</strong>:
<a href="http://apiserver.com/homes?limit=5&amp;format=json">?limit=5&amp;format=json</a></u></p>
<p><u>Rest API URL: <strong>BaseURL + Endpoint path +Query string</strong></u></p>
</blockquote>
</div>
<div id="vegetation-cover-in-two-time-periods" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Vegetation cover in two time periods<a href="query-data-from-nils.html#vegetation-cover-in-two-time-periods" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here and in the next chapter we show examples of how to integrate these APIs in your
workflow. The first example replicates Fig.3 a and b from <span class="citation">(<a href="#ref-hedenås2016">Hedenås, Christensen, and Svensson 2016</a>)</span>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="query-data-from-nils.html#cb23-1" tabindex="-1"></a><span class="co"># Set up</span></span>
<span id="cb23-2"><a href="query-data-from-nils.html#cb23-2" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb23-3"><a href="query-data-from-nils.html#cb23-3" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb23-4"><a href="query-data-from-nils.html#cb23-4" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb23-5"><a href="query-data-from-nils.html#cb23-5" tabindex="-1"></a><span class="fu">library</span>(conflicted)</span>
<span id="cb23-6"><a href="query-data-from-nils.html#cb23-6" tabindex="-1"></a><span class="fu">conflicts_prefer</span>( dplyr<span class="sc">::</span>select, dplyr<span class="sc">::</span>filter)</span>
<span id="cb23-7"><a href="query-data-from-nils.html#cb23-7" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb23-8"><a href="query-data-from-nils.html#cb23-8" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb23-9"><a href="query-data-from-nils.html#cb23-9" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div>
<p>The endpoint ‘Klasser’ points to the table with all categorical data sampled within
mountain areas, that is forest type, type of land cover. (Note: only for the mountain
areas at the moment).</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="query-data-from-nils.html#cb24-1" tabindex="-1"></a>urlApi <span class="ot">&lt;-</span> <span class="st">&#39;https://landskap.slu.se/api/nils/api/&#39;</span></span>
<span id="cb24-2"><a href="query-data-from-nils.html#cb24-2" tabindex="-1"></a>endpoint <span class="ot">&lt;-</span> <span class="st">&#39;Klasser&#39;</span></span>
<span id="cb24-3"><a href="query-data-from-nils.html#cb24-3" tabindex="-1"></a>klasserUrl <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="fu">glue</span>(<span class="st">&#39;{urlApi}{endpoint}&#39;</span>))</span>
<span id="cb24-4"><a href="query-data-from-nils.html#cb24-4" tabindex="-1"></a>klasserGet <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(klasserUrl)</span>
<span id="cb24-5"><a href="query-data-from-nils.html#cb24-5" tabindex="-1"></a>klasser <span class="ot">&lt;-</span> klasserGet<span class="sc">$</span>data</span></code></pre></div>
<p>This is exactly what we what to avoid. We want to filter the query to obtain a
restricted data set only containing data collected between 2003 and 2012.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="query-data-from-nils.html#cb25-1" tabindex="-1"></a>urlApi <span class="ot">&lt;-</span> <span class="st">&#39;https://landskap.slu.se/api/nils/api/&#39;</span></span>
<span id="cb25-2"><a href="query-data-from-nils.html#cb25-2" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&#39;Ar=&#39;</span>,<span class="fu">c</span>(<span class="dv">2003</span><span class="sc">:</span><span class="dv">2012</span>), <span class="at">collapse =</span> <span class="st">&#39;&amp;&#39;</span>)</span>
<span id="cb25-3"><a href="query-data-from-nils.html#cb25-3" tabindex="-1"></a>endpoint <span class="ot">&lt;-</span> <span class="st">&#39;Klasser&#39;</span></span>
<span id="cb25-4"><a href="query-data-from-nils.html#cb25-4" tabindex="-1"></a>klasserUrl <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="fu">glue</span>(<span class="st">&#39;{urlApi}{endpoint}?{years}&#39;</span>))</span>
<span id="cb25-5"><a href="query-data-from-nils.html#cb25-5" tabindex="-1"></a>klasserGet <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(klasserUrl)</span>
<span id="cb25-6"><a href="query-data-from-nils.html#cb25-6" tabindex="-1"></a>klasser <span class="ot">&lt;-</span> klasserGet<span class="sc">$</span>data</span></code></pre></div>
<p>We also want some data from the table ‘Vegetationstackning’ that contains the cover
(%) of different vegetation layers. In this case, however, we don’t want to preserve
all columns, just those that are unique in the classes table.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="query-data-from-nils.html#cb26-1" tabindex="-1"></a>endpoint <span class="ot">&lt;-</span> <span class="st">&#39;Vegetationstackning&#39;</span></span>
<span id="cb26-2"><a href="query-data-from-nils.html#cb26-2" tabindex="-1"></a>vegetationUrl <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="fu">glue</span>(<span class="st">&#39;{urlApi}{endpoint}?{years}&#39;</span>))</span>
<span id="cb26-3"><a href="query-data-from-nils.html#cb26-3" tabindex="-1"></a>vegetationGet <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(vegetationUrl)</span>
<span id="cb26-4"><a href="query-data-from-nils.html#cb26-4" tabindex="-1"></a>vegetation <span class="ot">&lt;-</span> vegetationGet<span class="sc">$</span>data <span class="sc">|&gt;</span></span>
<span id="cb26-5"><a href="query-data-from-nils.html#cb26-5" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">&quot;koordNS&quot;</span>,<span class="st">&quot;koordEW&quot;</span>,<span class="st">&quot;lan&quot;</span>,<span class="st">&quot;kommun&quot;</span>,<span class="st">&quot;bioGeoRegion&quot;</span>,<span class="st">&quot;stratum&quot;</span>)) </span>
<span id="cb26-6"><a href="query-data-from-nils.html#cb26-6" tabindex="-1"></a><span class="co"># Ta bort de kolumner som finns i bägge apierna och som inte behövs för att slå samman tabellerna</span></span></code></pre></div>
<p>Then, following <span class="citation">(<a href="#ref-hedenås2016">Hedenås, Christensen, and Svensson 2016</a>)</span> we proceed to:</p>
<ol style="list-style-type: decimal">
<li><p>filter out the the irrelevant ‘lan’ and leave only the mountain types
“Fjällbjörkskog”, “Område ovan SKOGSgränsen”;</p></li>
<li><p>join these tables by those fields that they have in common: “ar”,“rutaNummer”,
“provytaNummer”,“delytaNummer”; and</p></li>
<li><p>generate a categorical variable for the inventory phase (in NILS, every sample
area is visited once within five years)</p></li>
</ol>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="query-data-from-nils.html#cb27-1" tabindex="-1"></a>klassVegetation <span class="ot">&lt;-</span> klasser  <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="query-data-from-nils.html#cb27-2" tabindex="-1"></a>  <span class="fu">filter</span>(lan <span class="sc">!=</span> <span class="st">&quot;Utlandet&quot;</span>, </span>
<span id="cb27-3"><a href="query-data-from-nils.html#cb27-3" tabindex="-1"></a>         fjalltyp <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Fjällbjörkskog&quot;</span>, <span class="st">&quot;Område ovan SKOGSgränsen&quot;</span>)) <span class="sc">|&gt;</span> <span class="co">#</span></span>
<span id="cb27-4"><a href="query-data-from-nils.html#cb27-4" tabindex="-1"></a>  <span class="fu">left_join</span>(vegetation, </span>
<span id="cb27-5"><a href="query-data-from-nils.html#cb27-5" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;ar&quot;</span>,<span class="st">&quot;rutaNummer&quot;</span>, <span class="st">&quot;provytaNummer&quot;</span>,<span class="st">&quot;delytaNummer&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb27-6"><a href="query-data-from-nils.html#cb27-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">invPha =</span> <span class="fu">ifelse</span>(ar <span class="sc">&lt;</span> <span class="dv">2007</span>, <span class="st">&quot;2003-2007&quot;</span>, <span class="st">&quot;2008-2012&quot;</span>))</span></code></pre></div>
<p>To be able to work further we need to transpose the ‘wide’ table into a ‘long’ table:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="query-data-from-nils.html#cb28-1" tabindex="-1"></a>klassVegetationPL <span class="ot">&lt;-</span> klassVegetation <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="query-data-from-nils.html#cb28-2" tabindex="-1"></a>  <span class="fu">select</span>(fjalltyp, invPha, tradTackningTotal, buskTackningTotal, faltskiktTackningTotal) <span class="sc">|&gt;</span> </span>
<span id="cb28-3"><a href="query-data-from-nils.html#cb28-3" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">!</span><span class="fu">c</span>(fjalltyp, invPha), </span>
<span id="cb28-4"><a href="query-data-from-nils.html#cb28-4" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;layer&quot;</span>, </span>
<span id="cb28-5"><a href="query-data-from-nils.html#cb28-5" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;cover&quot;</span>)</span></code></pre></div>
<p>and finally summarize per group:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="query-data-from-nils.html#cb29-1" tabindex="-1"></a>kvSumm <span class="ot">&lt;-</span> klassVegetationPL <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="query-data-from-nils.html#cb29-2" tabindex="-1"></a>  <span class="fu">group_by</span>(fjalltyp, invPha, layer) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="query-data-from-nils.html#cb29-3" tabindex="-1"></a>  <span class="fu">summarise_at</span>(<span class="at">.vars =</span> <span class="fu">vars</span>(cover), </span>
<span id="cb29-4"><a href="query-data-from-nils.html#cb29-4" tabindex="-1"></a>               <span class="at">.funs =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="sc">~</span><span class="fu">mean</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb29-5"><a href="query-data-from-nils.html#cb29-5" tabindex="-1"></a>                            <span class="at">sd =</span> <span class="sc">~</span><span class="fu">sd</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb29-6"><a href="query-data-from-nils.html#cb29-6" tabindex="-1"></a>               <span class="at">.grups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-7"><a href="query-data-from-nils.html#cb29-7" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(invPha), <span class="fu">list</span>(factor)) <span class="sc">|&gt;</span> </span>
<span id="cb29-8"><a href="query-data-from-nils.html#cb29-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fjalltyp =</span> <span class="fu">factor</span>(fjalltyp, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Område ovan SKOGSgränsen&quot;</span>, <span class="st">&quot;Fjällbjörkskog&quot;</span>)),</span>
<span id="cb29-9"><a href="query-data-from-nils.html#cb29-9" tabindex="-1"></a>         <span class="at">layer =</span> <span class="fu">factor</span>(layer, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;tradTackningTotal&quot;</span>, <span class="st">&quot;buskTackningTotal&quot;</span>, <span class="st">&quot;faltskiktTackningTotal&quot;</span>))) <span class="sc">|&gt;</span> <span class="co"># to reorder the classes</span></span>
<span id="cb29-10"><a href="query-data-from-nils.html#cb29-10" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<p>All it is left to do, is produce a nice plot.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="query-data-from-nils.html#cb30-1" tabindex="-1"></a><span class="fu">ggplot</span>(kvSumm, <span class="fu">aes</span>(<span class="at">x =</span> layer, <span class="at">y =</span> mean, <span class="at">color =</span> invPha)) <span class="sc">+</span></span>
<span id="cb30-2"><a href="query-data-from-nils.html#cb30-2" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb30-3"><a href="query-data-from-nils.html#cb30-3" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> sd, </span>
<span id="cb30-4"><a href="query-data-from-nils.html#cb30-4" tabindex="-1"></a>                    <span class="at">ymax =</span> mean <span class="sc">+</span> sd), </span>
<span id="cb30-5"><a href="query-data-from-nils.html#cb30-5" tabindex="-1"></a>                <span class="at">width =</span> .<span class="dv">1</span>, </span>
<span id="cb30-6"><a href="query-data-from-nils.html#cb30-6" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.2</span>)) <span class="sc">+</span> </span>
<span id="cb30-7"><a href="query-data-from-nils.html#cb30-7" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(fjalltyp), </span>
<span id="cb30-8"><a href="query-data-from-nils.html#cb30-8" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">as_labeller</span>(<span class="fu">c</span>(<span class="st">&quot;Fjällbjörkskog&quot;</span> <span class="ot">=</span> <span class="st">&quot;Mountain birch forest&quot;</span>, </span>
<span id="cb30-9"><a href="query-data-from-nils.html#cb30-9" tabindex="-1"></a>                                      <span class="st">&quot;Område ovan SKOGSgränsen&quot;</span> <span class="ot">=</span> <span class="st">&quot;Alpine&quot;</span>))) <span class="sc">+</span></span>
<span id="cb30-10"><a href="query-data-from-nils.html#cb30-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Total cover (%)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Layer&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Inventory phase&quot;</span>) <span class="sc">+</span></span>
<span id="cb30-11"><a href="query-data-from-nils.html#cb30-11" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Tree&quot;</span>, <span class="st">&quot;Shrub&quot;</span>, <span class="st">&quot;Field&quot;</span>))</span></code></pre></div>
<p><img src="biodiversity-analysis-tools_files/figure-html/plot_kvSumm-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>The resulting graph shows the estimated total canopy cover, total cover of shrubs, and
total cover of field vegetation, during the initial inventory (2003– 2007) and the
re-inventory (2008–2012) in the alpine area and in the mountain birch forest. Further
refinement of this graph for the publication shows estimates of cover with a 95%
confidence interval and a separation of cover types to unlink y-axis values in the
figure.</p>
</div>
<div id="blueberry-and-mountain-violet-occurrence-in-the-alpine-region" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Blueberry and mountain violet occurrence in the alpine region<a href="query-data-from-nils.html#blueberry-and-mountain-violet-occurrence-in-the-alpine-region" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Following with NILS data we will now illustrate another example, this time from the
report Skog &amp; Mark 2015 <span class="citation">(<a href="#ref-naturvårdsverket2015">Naturvårdsverket 2015</a>)</span>. In this example we reproduce the
analys done in the first chapter with the aim to compare presence of two species at
different altitudes in the mountain range.</p>
<p>In this case we query the endpoint ‘SmaprovytaArter’ that contains the occurrence of
different species per sample area.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="query-data-from-nils.html#cb31-1" tabindex="-1"></a>urlApi <span class="ot">&lt;-</span> <span class="st">&#39;https://landskap.slu.se/api/nils/api/&#39;</span></span>
<span id="cb31-2"><a href="query-data-from-nils.html#cb31-2" tabindex="-1"></a>endpoint <span class="ot">&lt;-</span> <span class="st">&#39;SmaprovytaArter&#39;</span></span>
<span id="cb31-3"><a href="query-data-from-nils.html#cb31-3" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&#39;Ar=&#39;</span>,<span class="fu">c</span>(<span class="dv">2003</span><span class="sc">:</span><span class="dv">2012</span>), <span class="at">collapse =</span> <span class="st">&#39;&amp;&#39;</span>)</span>
<span id="cb31-4"><a href="query-data-from-nils.html#cb31-4" tabindex="-1"></a>region <span class="ot">&lt;-</span> <span class="st">&#39;BioGeoRegion=Alpin&#39;</span></span>
<span id="cb31-5"><a href="query-data-from-nils.html#cb31-5" tabindex="-1"></a></span>
<span id="cb31-6"><a href="query-data-from-nils.html#cb31-6" tabindex="-1"></a>pyUrl <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="fu">glue</span>(<span class="st">&#39;{urlApi}{endpoint}?{years}&amp;{region}&#39;</span>))</span>
<span id="cb31-7"><a href="query-data-from-nils.html#cb31-7" tabindex="-1"></a>pyGet <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(pyUrl)</span>
<span id="cb31-8"><a href="query-data-from-nils.html#cb31-8" tabindex="-1"></a>py <span class="ot">&lt;-</span> pyGet<span class="sc">$</span>data <span class="sc">|&gt;</span> </span>
<span id="cb31-9"><a href="query-data-from-nils.html#cb31-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">uuid =</span> <span class="fu">glue</span>(<span class="st">&#39;{rutaNummer}-{provytaNummer}&#39;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb31-10"><a href="query-data-from-nils.html#cb31-10" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(uuid, vetenskapligtNamn), <span class="fu">list</span>(factor))</span>
<span id="cb31-11"><a href="query-data-from-nils.html#cb31-11" tabindex="-1"></a></span>
<span id="cb31-12"><a href="query-data-from-nils.html#cb31-12" tabindex="-1"></a>pySpp <span class="ot">&lt;-</span> py <span class="sc">|&gt;</span> </span>
<span id="cb31-13"><a href="query-data-from-nils.html#cb31-13" tabindex="-1"></a>  <span class="fu">group_by</span>(uuid, ar) <span class="sc">|&gt;</span> </span>
<span id="cb31-14"><a href="query-data-from-nils.html#cb31-14" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">coordNS =</span> <span class="fu">unique</span>(koordNS),</span>
<span id="cb31-15"><a href="query-data-from-nils.html#cb31-15" tabindex="-1"></a>          <span class="at">coordEW =</span> <span class="fu">unique</span>(koordEW),</span>
<span id="cb31-16"><a href="query-data-from-nils.html#cb31-16" tabindex="-1"></a>          <span class="at">presBB =</span> <span class="fu">ifelse</span>(<span class="st">&quot;Vaccinium myrtillus&quot;</span> <span class="sc">%in%</span> vetenskapligtNamn, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb31-17"><a href="query-data-from-nils.html#cb31-17" tabindex="-1"></a>          <span class="at">presAV =</span> <span class="fu">ifelse</span>(<span class="st">&quot;Viola biflora&quot;</span> <span class="sc">%in%</span> vetenskapligtNamn, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb31-18"><a href="query-data-from-nils.html#cb31-18" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<p>In the same way we query NILS, there are many other sources of data. We query
<a href="opentopodata.org">opentopodata.org</a> the obtain the altitude at specific coordinates.
But first we need to convert NILS sample areas coordinates into a coordinate system
that this new service can understand (WGS84). And we want to make the query only one
per sample area, as they wont go anywhere between sampling events.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="query-data-from-nils.html#cb32-1" tabindex="-1"></a>pySf <span class="ot">&lt;-</span> py <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="query-data-from-nils.html#cb32-2" tabindex="-1"></a>  <span class="fu">group_by</span>(uuid) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="query-data-from-nils.html#cb32-3" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">coordNS =</span> <span class="fu">unique</span>(koordNS),</span>
<span id="cb32-4"><a href="query-data-from-nils.html#cb32-4" tabindex="-1"></a>          <span class="at">coordEW =</span> <span class="fu">unique</span>(koordEW)) <span class="sc">|&gt;</span>  </span>
<span id="cb32-5"><a href="query-data-from-nils.html#cb32-5" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb32-6"><a href="query-data-from-nils.html#cb32-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">geom =</span> <span class="fu">st_sfc</span>(<span class="fu">list</span>(<span class="fu">st_point</span>(<span class="fu">c</span>(coordEW, coordNS))),</span>
<span id="cb32-7"><a href="query-data-from-nils.html#cb32-7" tabindex="-1"></a>                       <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">3006</span>))) <span class="sc">|&gt;</span> <span class="co"># SWEREF99 TM</span></span>
<span id="cb32-8"><a href="query-data-from-nils.html#cb32-8" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb32-9"><a href="query-data-from-nils.html#cb32-9" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(<span class="dv">4326</span>)) <span class="co"># WGS84</span></span>
<span id="cb32-10"><a href="query-data-from-nils.html#cb32-10" tabindex="-1"></a></span>
<span id="cb32-11"><a href="query-data-from-nils.html#cb32-11" tabindex="-1"></a>pySf<span class="sc">$</span>elevation <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb32-12"><a href="query-data-from-nils.html#cb32-12" tabindex="-1"></a></span>
<span id="cb32-13"><a href="query-data-from-nils.html#cb32-13" tabindex="-1"></a>locations <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(pySf) <span class="sc">|&gt;</span> </span>
<span id="cb32-14"><a href="query-data-from-nils.html#cb32-14" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb32-15"><a href="query-data-from-nils.html#cb32-15" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot;latitude&quot;</span> <span class="ot">=</span> Y, </span>
<span id="cb32-16"><a href="query-data-from-nils.html#cb32-16" tabindex="-1"></a>         <span class="st">&quot;longitude&quot;</span> <span class="ot">=</span> X)</span></code></pre></div>
<p>We also want to iterate the query as this service has a quota of max 100 locations per
call.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="query-data-from-nils.html#cb33-1" tabindex="-1"></a>nLocations <span class="ot">&lt;-</span> <span class="fu">nrow</span>(locations)</span>
<span id="cb33-2"><a href="query-data-from-nils.html#cb33-2" tabindex="-1"></a>queryLimit <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb33-3"><a href="query-data-from-nils.html#cb33-3" tabindex="-1"></a>lChunks <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">seq</span>(nLocations), <span class="fu">ceiling</span>(<span class="fu">seq</span>(nLocations)<span class="sc">/</span>queryLimit))</span>
<span id="cb33-4"><a href="query-data-from-nils.html#cb33-4" tabindex="-1"></a></span>
<span id="cb33-5"><a href="query-data-from-nils.html#cb33-5" tabindex="-1"></a>urlAlt <span class="ot">&lt;-</span> <span class="st">&quot;https://api.opentopodata.org/v1/&quot;</span></span>
<span id="cb33-6"><a href="query-data-from-nils.html#cb33-6" tabindex="-1"></a>endpoint <span class="ot">&lt;-</span> <span class="st">&quot;eudem25m&quot;</span></span>
<span id="cb33-7"><a href="query-data-from-nils.html#cb33-7" tabindex="-1"></a></span>
<span id="cb33-8"><a href="query-data-from-nils.html#cb33-8" tabindex="-1"></a><span class="cf">for</span> (l <span class="cf">in</span> <span class="fu">seq</span>(<span class="fu">length</span>(lChunks))) {</span>
<span id="cb33-9"><a href="query-data-from-nils.html#cb33-9" tabindex="-1"></a>  loc <span class="ot">&lt;-</span> locations[lChunks[[l]],] <span class="sc">|&gt;</span> </span>
<span id="cb33-10"><a href="query-data-from-nils.html#cb33-10" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">&quot;xy&quot;</span> <span class="ot">=</span> <span class="fu">glue</span>(<span class="st">&quot;{round(latitude,5)},{round(longitude,5)}&quot;</span>))</span>
<span id="cb33-11"><a href="query-data-from-nils.html#cb33-11" tabindex="-1"></a>  loc <span class="ot">&lt;-</span> <span class="fu">paste0</span>(loc<span class="sc">$</span>xy, <span class="at">collapse =</span> <span class="st">&quot;|&quot;</span>)  </span>
<span id="cb33-12"><a href="query-data-from-nils.html#cb33-12" tabindex="-1"></a>  elevUrl <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="fu">glue</span>(<span class="st">&quot;{urlAlt}{endpoint}?locations={loc}&quot;</span>))</span>
<span id="cb33-13"><a href="query-data-from-nils.html#cb33-13" tabindex="-1"></a>  elevGet <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(elevUrl)</span>
<span id="cb33-14"><a href="query-data-from-nils.html#cb33-14" tabindex="-1"></a>  elevation <span class="ot">&lt;-</span> elevGet<span class="sc">$</span>results</span>
<span id="cb33-15"><a href="query-data-from-nils.html#cb33-15" tabindex="-1"></a>  pySf<span class="sc">$</span>elevation[lChunks[[l]]] <span class="ot">&lt;-</span> elevation<span class="sc">$</span>elevation</span>
<span id="cb33-16"><a href="query-data-from-nils.html#cb33-16" tabindex="-1"></a>}</span></code></pre></div>
<p>We put everything together (join) and summarise the proportion of sample areas per
inventory phase and elevation group.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="query-data-from-nils.html#cb34-1" tabindex="-1"></a>pySf<span class="sc">$</span>elevationBin <span class="ot">&lt;-</span> <span class="fu">cut</span>(pySf<span class="sc">$</span>elevation, </span>
<span id="cb34-2"><a href="query-data-from-nils.html#cb34-2" tabindex="-1"></a>                         <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">300</span>,<span class="dv">1000</span>, <span class="dv">50</span>),<span class="cn">Inf</span>),</span>
<span id="cb34-3"><a href="query-data-from-nils.html#cb34-3" tabindex="-1"></a>                         <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">right =</span> <span class="cn">FALSE</span>)</span>
<span id="cb34-4"><a href="query-data-from-nils.html#cb34-4" tabindex="-1"></a></span>
<span id="cb34-5"><a href="query-data-from-nils.html#cb34-5" tabindex="-1"></a>elevBinLabel <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;300-349&quot;</span>,<span class="st">&quot;350-399&quot;</span>,<span class="st">&quot;400-449&quot;</span>,<span class="st">&quot;450-499&quot;</span>,<span class="st">&quot;500-549&quot;</span>,<span class="st">&quot;550-599&quot;</span>,</span>
<span id="cb34-6"><a href="query-data-from-nils.html#cb34-6" tabindex="-1"></a>                  <span class="st">&quot;600-649&quot;</span>,<span class="st">&quot;650-699&quot;</span>,<span class="st">&quot;700-749&quot;</span>,<span class="st">&quot;750-799&quot;</span>,<span class="st">&quot;800-849&quot;</span>,<span class="st">&quot;850-899&quot;</span>,</span>
<span id="cb34-7"><a href="query-data-from-nils.html#cb34-7" tabindex="-1"></a>                  <span class="st">&quot;900-949&quot;</span>,<span class="st">&quot;950-999&quot;</span>,<span class="st">&quot;&gt;=1000&quot;</span>)</span>
<span id="cb34-8"><a href="query-data-from-nils.html#cb34-8" tabindex="-1"></a></span>
<span id="cb34-9"><a href="query-data-from-nils.html#cb34-9" tabindex="-1"></a>pySpp<span class="sc">$</span>invPha <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(pySpp<span class="sc">$</span>ar)) <span class="sc">&gt;</span> <span class="dv">2007</span>, </span>
<span id="cb34-10"><a href="query-data-from-nils.html#cb34-10" tabindex="-1"></a>                        <span class="st">&quot;2008-2012&quot;</span>, <span class="st">&quot;2003-2007&quot;</span>)</span>
<span id="cb34-11"><a href="query-data-from-nils.html#cb34-11" tabindex="-1"></a></span>
<span id="cb34-12"><a href="query-data-from-nils.html#cb34-12" tabindex="-1"></a>pySum <span class="ot">&lt;-</span> pySpp <span class="sc">|&gt;</span> </span>
<span id="cb34-13"><a href="query-data-from-nils.html#cb34-13" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">st_drop_geometry</span>(pySf)) <span class="sc">|&gt;</span> </span>
<span id="cb34-14"><a href="query-data-from-nils.html#cb34-14" tabindex="-1"></a>  <span class="fu">group_by</span>(invPha, elevationBin) <span class="sc">|&gt;</span> </span>
<span id="cb34-15"><a href="query-data-from-nils.html#cb34-15" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb34-16"><a href="query-data-from-nils.html#cb34-16" tabindex="-1"></a>          <span class="at">sumPresBB =</span> <span class="fu">sum</span>(presBB),</span>
<span id="cb34-17"><a href="query-data-from-nils.html#cb34-17" tabindex="-1"></a>          <span class="at">sumPresAV =</span> <span class="fu">sum</span>(presAV)) <span class="sc">|&gt;</span> </span>
<span id="cb34-18"><a href="query-data-from-nils.html#cb34-18" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">occBB =</span> sumPresBB<span class="sc">/</span>count<span class="sc">*</span><span class="dv">100</span>,</span>
<span id="cb34-19"><a href="query-data-from-nils.html#cb34-19" tabindex="-1"></a>         <span class="at">occAV =</span> sumPresAV<span class="sc">/</span>count<span class="sc">*</span><span class="dv">100</span>)</span></code></pre></div>
<p>and finally, we create a beautiful plot.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="query-data-from-nils.html#cb35-1" tabindex="-1"></a><span class="fu">ggplot</span>(pySum, <span class="fu">aes</span>(<span class="at">x =</span> elevationBin, <span class="at">y =</span> variable)) <span class="sc">+</span></span>
<span id="cb35-2"><a href="query-data-from-nils.html#cb35-2" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> occBB, <span class="at">col =</span> invPha), </span>
<span id="cb35-3"><a href="query-data-from-nils.html#cb35-3" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.1</span>), </span>
<span id="cb35-4"><a href="query-data-from-nils.html#cb35-4" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">19</span>) <span class="sc">+</span></span>
<span id="cb35-5"><a href="query-data-from-nils.html#cb35-5" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> occAV, <span class="at">col =</span> invPha), </span>
<span id="cb35-6"><a href="query-data-from-nils.html#cb35-6" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.1</span>), </span>
<span id="cb35-7"><a href="query-data-from-nils.html#cb35-7" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb35-8"><a href="query-data-from-nils.html#cb35-8" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Occurrence of two species in the mountains&quot;</span>,</span>
<span id="cb35-9"><a href="query-data-from-nils.html#cb35-9" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Occurrence (%)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Altitude (m.a.s.l.)&quot;</span>, </span>
<span id="cb35-10"><a href="query-data-from-nils.html#cb35-10" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Inventory phase&quot;</span>) <span class="sc">+</span></span>
<span id="cb35-11"><a href="query-data-from-nils.html#cb35-11" tabindex="-1"></a>  <span class="do">### add a dummy dataset for the shape legend</span></span>
<span id="cb35-12"><a href="query-data-from-nils.html#cb35-12" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Blueberry&#39;</span>,<span class="st">&#39;Alpine yellow-violet&#39;</span>), <span class="dv">15</span>), </span>
<span id="cb35-13"><a href="query-data-from-nils.html#cb35-13" tabindex="-1"></a>                 <span class="at">y =</span> occBB), <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb35-14"><a href="query-data-from-nils.html#cb35-14" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">2</span>)),</span>
<span id="cb35-15"><a href="query-data-from-nils.html#cb35-15" tabindex="-1"></a>         <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="st">&quot;Species&quot;</span>, </span>
<span id="cb35-16"><a href="query-data-from-nils.html#cb35-16" tabindex="-1"></a>                             <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">19</span>), </span>
<span id="cb35-17"><a href="query-data-from-nils.html#cb35-17" tabindex="-1"></a>                                                 <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb35-18"><a href="query-data-from-nils.html#cb35-18" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb35-19"><a href="query-data-from-nils.html#cb35-19" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> elevBinLabel) <span class="sc">+</span> </span>
<span id="cb35-20"><a href="query-data-from-nils.html#cb35-20" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>))</span></code></pre></div>
<p><img src="biodiversity-analysis-tools_files/figure-html/plotOcc-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>The resulting graphs show the percentage of NILS sample areas with blueberries
(<em>Vaccinium myrtillus</em>) or alpine yellow-violet (<em>Viola biflora</em>) in the mountains at
different altitudes for both inventory phases (2003–2007, 2008–2012).</p>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-hedenås2016" class="csl-entry">
Hedenås, Henrik, Pernilla Christensen, and Johan Svensson. 2016. <span>“Changes in Vegetation Cover and Composition in the Swedish Mountain Region.”</span> <em>Environmental Monitoring and Assessment</em> 188 (8): 452. <a href="https://doi.org/10.1007/s10661-016-5457-2">https://doi.org/10.1007/s10661-016-5457-2</a>.
</div>
<div id="ref-naturvårdsverket2015" class="csl-entry">
Naturvårdsverket. 2015. <span>“Skog &amp; mark: om tillståndet i svensk landmiljö.”</span> Stockholm. <a href="https://urn.kb.se/resolve?urn=urn:nbn:se:naturvardsverket:diva-10182">https://urn.kb.se/resolve?urn=urn:nbn:se:naturvardsverket:diva-10182</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="essential-biodiversity-variables.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
